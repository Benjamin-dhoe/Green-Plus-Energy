<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <title>Admin</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/greenplus-energy.webflow.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Inconsolata:400,700"]  }});</script>
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.png" rel="apple-touch-icon">
</head>
<body class="body">
  <div class="section">
        <div class="contain-center paddabove">
              <h2 class="heading">Admin paneel</h2>
              <div style="margin-top: 10px;">
                <a href="/" class="paswoord-forget" style="color: white;">Ga naar naar homepage website</a>
              </div>
              <div class="backendpart">
              <div class="headingandbutton">
                <div class="heading" style="font-weight: 600">Cases</div>
                <a href="#newcase" class="button w-button">Case toevoegen</a>
              </div>
              <div class="scrollable">
              <table class="table-systeem">
                <thead>
                  <tr>
                    <th class="th-systeem">Case</th>
                    <th class="th-systeem">Locatie</th>
                    <th class="th-systeem">Datum</th>
                    <th class="th-systeem">Acties</th>
                  </tr>
                </thead>
                <tbody>
              
                </tbody>
              </table>
            </div>
              <a href="#newcase" class="buttonadd w-inline-block">
                <div class="plussign">+</div>
                <div>case toevoegen</div>
              </a>
            </div>
        </div>
    <div id="newcase" class="backendpart">
        <div class="form-block w-form">
          <form class="form" id="caseform">
            <div class="holderinputfield">
              <label for="title" class="inputlabel">Case titel</label>
              <input class="inputfield w-input" maxlength="256" name="title" placeholder="" type="text">
            </div>
            <div class="holderinputfield">
                <label for="location" class="inputlabel">Locatie</label>
                <input class="inputfield withnumber w-input" maxlength="256" name="location" placeholder="" type="text">
            </div>
            <div class="holderinputfield">
                <label for="datum" class="inputlabel">Datum</label>
                <input class="inputfield withnumber w-input" maxlength="256" name="datum" placeholder="" type="text">
            </div>
            <div class="holderinputfield">
              <label for="description" class="inputlabel">Tekst</label>
              <textarea placeholder="" name="tekst" class="inputfield area w-input"></textarea>
            </div>
            <div id="holder-images"></div>
            <div class="holderinputfield">
              <label for="upload" class="inputlabel upload">Afbeelding toevoegen</label>
              <input type="file" accept="image/*" name="upload" id="upload">
            </div>
            <button class="button w-button">Case opslagen</button>
          </form>
        </div>
      </div>
      </div> 
<div id="editPopup" class="popup">
  <div class="popup-content">
    <button class="close-button w-button" id="closePopup">&times;</button>
    <h2>Edit Case</h2>
    <form id="editCaseForm">
      <label>Case Titel</label>
      <input type="text" id="editTitle" name="editTitle">
      <label>Locatie</label>
      <input type="text" id="editLocation" name="editLocation">
      <label>Datum</label>
      <input type="text" id="editDatum" name="editDatum">
      <label>Tekst</label>
      <textarea id="editTekst" name="editTekst"></textarea>
      <button type="submit">Update</button>
    </form>
  </div>
</div>
<script src="/js/index.js" type="text/javascript"></script>
<script type="module">
import { db } from "/js/firebase.js";
import { 
  collection, getDocs, addDoc, updateDoc, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { 
  getStorage, ref, uploadBytes, getDownloadURL, deleteObject 
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const casesCollection = collection(db, "Cases");
const storage = getStorage();
const tableBody = document.querySelector(".table-systeem tbody");
const caseForm = document.getElementById("caseform");
const editPopup = document.getElementById("editPopup");
const editForm = document.getElementById("editCaseForm");
const imageHolder = document.getElementById("holder-images");
const uploadInput = document.getElementById("upload");
let currentEditId = null;
let uploadedImages = [];

// Load Cases
async function loadCases() {
  tableBody.innerHTML = "";
  const snapshot = await getDocs(casesCollection);
  snapshot.forEach(doc => {
    const data = doc.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="td-systeem">${data.title}</td>
      <td class="td-systeem">${data.location}</td>
      <td class="td-systeem">${data.datum}</td>
      <td class="td-systeem">
        <button class="edit-btn" onclick="openEditPopup('${doc.id}', '${data.title}', '${data.location}', '${data.datum}', ${JSON.stringify(data.images || [])})">Edit</button>
        <button class="delete-btn" onclick="deleteCase('${doc.id}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

// Upload Images and Get URLs
async function uploadImages(files) {
  const imageURLs = [];
  for (const file of files) {
    const storageRef = ref(storage, `cases/${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    imageURLs.push(url);
  }
  return imageURLs;
}

// Add Case
caseForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = caseForm.title.value;
  const location = caseForm.location.value;
  const datum = caseForm.datum.value;
  const tekst = caseForm.tekst.value;
  const images = await uploadImages(uploadInput.files);

  await addDoc(casesCollection, { title, location, datum, tekst, images });
  caseForm.reset();
  loadCases();
});

// Open Edit Popup
window.openEditPopup = (id, title, location, datum, images) => {
  document.getElementById("editTitle").value = title;
  document.getElementById("editLocation").value = location;
  document.getElementById("editDatum").value = datum;
  document.getElementById("editTekst").value = "";
  currentEditId = id;
  uploadedImages = images;

  imageHolder.innerHTML = images.map((url, index) => `
    <div class="image-preview">
      <img src="${url}" width="100">
      <button onclick="removeImage(${index})">X</button>
    </div>
  `).join("");

  editPopup.style.display = "flex";
};

// Remove Image from the list
window.removeImage = (index) => {
  uploadedImages.splice(index, 1);
  openEditPopup(currentEditId, 
    document.getElementById("editTitle").value, 
    document.getElementById("editLocation").value, 
    document.getElementById("editDatum").value, 
    uploadedImages
  );
};

// Edit Case
editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentEditId) return;

  const title = editForm.editTitle.value;
  const location = editForm.editLocation.value;
  const datum = editForm.editDatum.value;
  const tekst = editForm.editTekst.value;

  // Upload new images and merge with existing ones
  const newImages = await uploadImages(uploadInput.files);
  const updatedImages = [...uploadedImages, ...newImages];

  await updateDoc(doc(db, "Cases", currentEditId), { title, location, datum, tekst, images: updatedImages });
  editPopup.style.display = "none";
  loadCases();
});

// Delete Case
window.deleteCase = async (id) => {
  await deleteDoc(doc(db, "Cases", id));
  loadCases();
};

// Close Edit Popup
document.getElementById("closePopup").addEventListener("click", () => {
  editPopup.style.display = "none";
});

// Load cases on page load
loadCases();
</script>
</body>
</html>
